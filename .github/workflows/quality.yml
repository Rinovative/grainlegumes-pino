name: Quality Checks

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: environment-dev.yml
          cache-environment: true
          cache-downloads: true
          init-shell: bash

      - name: Run Ruff (Lint + Format)
        shell: bash -l {0}
        run: |
          ruff check . || true
          ruff format --check . --exclude "*.ipynb" || true

      - name: Run Type Checking (mypy)
        shell: bash -l {0}
        run: |
          mypy . || true

      - name: Complexity Analysis
        shell: bash -l {0}
        run: |
          python - << 'EOF'
          import json, subprocess
          from statistics import mean
          from collections import defaultdict

          # ----------------------------------------------------------
          # Run radon
          # ----------------------------------------------------------
          result = subprocess.run(
              ["radon", "cc", "-j", "."],
              capture_output=True,
              text=True
          )
          data = json.loads(result.stdout)

          # ----------------------------------------------------------
          # Collect global blocks
          # ----------------------------------------------------------
          all_blocks = [b for blocks in data.values() for b in blocks]

          avg = mean(b["complexity"] for b in all_blocks) if all_blocks else 0.0

          # radon-style grade mapping
          def grade_from_complexity(c):
              if c <= 5: return "A"
              if c <= 10: return "B"
              if c <= 20: return "C"
              if c <= 30: return "D"
              if c <= 40: return "E"
              return "F"

          global_grade = grade_from_complexity(avg)

          # ----------------------------------------------------------
          # Worst-per-file summary
          # ----------------------------------------------------------
          rows = []
          for file, blocks in data.items():
              if not blocks:
                  continue
              worst = max(blocks, key=lambda b: b["complexity"])
              rows.append((worst["rank"], worst["complexity"], file, blocks))

          rows.sort(key=lambda x: x[1], reverse=True)

          grade_order = ["F","E","D","C","B","A"]
          grouped = defaultdict(list)
          for rank, cc, file, blocks in rows:
              grouped[rank].append((rank, cc, file, blocks))

          # ----------------------------------------------------------
          # GLOBAL SUMMARY
          # ----------------------------------------------------------
          print("\n=================== COMPLEXITY SUMMARY ===================\n")
          print(f"Total files analysed: {len(rows)}")
          print(f"Global complexity:     {global_grade} ({avg})\n")
          print("==========================================================\n")

          # ----------------------------------------------------------
          # COMPLEXITY PER FILE
          # ----------------------------------------------------------
          print("=================== COMPLEXITY PER FILE ===================\n")
          print(f"{'Grade':6} {'CC':10} File")
          print("==============================================================\n")

          first_group = True
          for grade in grade_order:
              if grade not in grouped:
                  continue

              if not first_group:
                  print("-------------------------------------------------------------------------------")
              first_group = False

              for rank, cc, file, blocks in grouped[grade]:
                  print(f"{rank:6} {cc:<10} {file}")
              print("")

          print("==============================================================\n")

          # ----------------------------------------------------------
          # FUNCTION BREAKDOWN
          # ----------------------------------------------------------
          print("=================== FUNCTION BREAKDOWN ===================\n")

          for grade in grade_order:
              if grade not in grouped:
                  continue
              for rank, cc, file, blocks in grouped[grade]:
                  print(f"------------------- {file} -------------------")
                  for b in sorted(blocks, key=lambda x: x["complexity"], reverse=True):
                      print(f"  {b['name']:40} {b['rank']} ({b['complexity']})")
                  print("")

          print("============================================================\n")
          EOF
