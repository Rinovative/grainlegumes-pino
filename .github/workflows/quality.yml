name: Quality Checks

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: environment-dev.yml
          cache-environment: true
          cache-downloads: true
          init-shell: bash

      - name: Run Ruff (Lint + Format)
        shell: bash -l {0}
        run: |
          ruff check . || true
          ruff format --check . --exclude "*.ipynb" || true

      - name: Run Type Checking (mypy)
        shell: bash -l {0}
        run: |
          mypy . || true

      - name: Complexity Analysis
        shell: bash -l {0}
        run: |
          python - << 'EOF'
          import json
          import subprocess

          def fmt(v: float) -> str:
              """Format: integers without decimals, everything else 2 decimals."""
              return str(int(v)) if float(v).is_integer() else f"{v:.2f}"

          # -----------------------------
          # Run radon
          # -----------------------------
          proc = subprocess.run(
              ["radon", "cc", "-j", "."],
              capture_output=True,
              text=True
          )
          data = json.loads(proc.stdout)

          # Mapping for sort order
          rank_sort = {"A": 1, "B": 2, "C": 3, "D": 4, "E": 5, "F": 6}

          # Collect global stats
          blocks_all = [b for file in data for b in data[file]]
          total_files = sum(1 for f in data if data[f])
          avg = sum(b["complexity"] for b in blocks_all) / len(blocks_all) if blocks_all else 0

          # -----------------------------
          # Per-file complexity
          # -----------------------------
          file_rows = []
          for file, blocks in data.items():
              if not blocks:
                  continue
              worst = max(blocks, key=lambda b: b["complexity"])
              file_rows.append((file, worst["rank"], worst["complexity"], blocks))

          file_rows.sort(key=lambda x: (rank_sort[x[1]], -x[2]))

          # ==========================================================
          # TABLE 1: SUMMARY
          # ==========================================================
          print("=================== COMPLEXITY SUMMARY ===================")
          print(f"Total files analysed: {total_files}")
          print(f"Global complexity:     {worst['rank']} ({fmt(avg)})")
          print("==========================================================\n")

          # ==========================================================
          # TABLE 2: PER FILE
          # ==========================================================
          print("=================== COMPLEXITY PER FILE ===================")
          print("Grade  CC          File")
          print("==============================================================")

          last_rank = None
          for file, rank, cc, _ in file_rows:
              if last_rank is not None and rank != last_rank:
                  print("-------------------------------------------------------------------------------")
              print(f"{rank:<6} {fmt(cc):<10} {file}")
              last_rank = rank

          print("==============================================================\n")

          # ==========================================================
          # TABLE 3: FUNCTION BREAKDOWN
          # ==========================================================
          print("=================== FUNCTION BREAKDOWN ===================")
          print("Item                                         Grade(CC)")
          print("============================================================")

          for file, rank, cc, blocks in file_rows:
              print("------------------------------------------------------------")
              print(file)
              blocks_sorted = sorted(blocks, key=lambda b: b["complexity"], reverse=True)
              for b in blocks_sorted:
                  cc_fmt = fmt(b["complexity"])
                  print(f"  {b['name']:<40} {b['rank']}({cc_fmt})")

          print("============================================================")
          EOF
