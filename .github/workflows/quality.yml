name: Quality Checks

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: environment-dev.yml
          cache-environment: true
          cache-downloads: true
          init-shell: bash

      - name: Run Ruff (Lint + Format)
        shell: bash -l {0}
        run: |
          ruff check . || true
          ruff format --check . --exclude "*.ipynb" || true

      - name: Run Type Checking (mypy)
        shell: bash -l {0}
        run: |
          mypy . || true

      - name: Complexity Analysis
        shell: bash -l {0}
        run: |
          python - << 'EOF'
          import json, subprocess
          from statistics import mean
          from collections import defaultdict

          # format helper: ints → int, floats → rounded to 2 decimals
          def fmt(v):
              v = float(v)
              if v.is_integer():
                  return str(int(v))
              return f"{v:.2f}"

          # global grade helper
          def grade_for(c):
              if c <= 5: return "A"
              if c <= 10: return "B"
              if c <= 20: return "C"
              if c <= 30: return "D"
              if c <= 40: return "E"
              return "F"

          # run radon
          result = subprocess.run(["radon", "cc", "-j", "."], capture_output=True, text=True)
          data = json.loads(result.stdout)

          all_blocks = [b for blocks in data.values() for b in blocks]
          avg_c = mean(b["complexity"] for b in all_blocks) if all_blocks else 0.0
          global_grade = grade_for(avg_c)

          # collect worst per file
          rows = []
          for file, blocks in data.items():
              if not blocks:
                  continue
              worst = max(blocks, key=lambda b: b["complexity"])
              rows.append((worst["rank"], worst["complexity"], file, blocks))

          rows.sort(key=lambda x: x[1], reverse=True)

          grade_order = ["F","E","D","C","B","A"]
          groups = defaultdict(list)
          for r, c, file, blocks in rows:
              groups[r].append((r, c, file, blocks))

          # ====================== SUMMARY ============================
          print("=================== COMPLEXITY SUMMARY ===================")
          print(f"Total files analysed: {len(rows)}")
          print(f"Global complexity:     {global_grade} ({avg_c:.2f})")
          print("==========================================================")
          print()

          # ====================== PER FILE TABLE ====================
          print("=================== COMPLEXITY PER FILE ===================")
          print("Grade  CC          File")
          print("==============================================================")

          first = True
          for grade in grade_order:
              if grade not in groups:
                  continue
              if not first:
                  print("-------------------------------------------------------------------------------")
              first = False
              for r, c, file, blocks in groups[grade]:
                  print(f"{r:6} {fmt(c):10} {file}")

          print("==============================================================")
          print()

          # ====================== FUNCTION BREAKDOWN TABLE ==========
          print("=================== FUNCTION BREAKDOWN ===================")
          print("Item                                         Grade(CC)")
          print("============================================================")

          for r, c, file, blocks in rows:
              print("------------------------------------------------------------")
              print(file)
              sorted_blocks = sorted(blocks, key=lambda x: x["complexity"], reverse=True)
              for b in sorted_blocks:
                  print(f"  {b['name']:40} {b['rank']}({fmt(b['complexity'])})")

          print("============================================================")
          EOF
